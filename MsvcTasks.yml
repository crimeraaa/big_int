version: '3'

# NOTE: `Fo` doesn't accept nor require ':' but `Fe` and `Fd` do.
vars:
  CXX: clang-cl
  CXX_COMMON_FLAGS: >-
    -nologo
    -W4
    -WX
    -std:c++17
    -EHsc
    -permissive-
    -Fe:"{{.OUT_EXE}}"
    -Fo"{{.OBJ}}/"
  CXX_DEBUG_FLAGS: >-
    -Od
    -Zi
    -Fd:"{{.BIN}}/"
    -fsanitize=address
    -DDEBUG_USE_ASSERT
  CXX_RELEASE_FLAGS: -O1
  
tasks:
  default:
    cmds:
      - task: build

  build:
    desc: Builds the C++ executable.
    deps:
      - task: :dirs
    vars:
      # Hack as long as `sources` is not supported in a variable and Windows CMD
      # cannot glob
      _SOURCES:
        sh: ls -1 '{{.SRC}}' | grep 'cpp$' | awk '{print "{{.SRC}}/" $0}'
      CXX_SOURCES: '{{._SOURCES | replace "\n" " "}}'
      CXX_FLAGS: >-
        {{.CXX_COMMON_FLAGS}}
        {{if eq .MODE "debug"}}
        {{.CXX_DEBUG_FLAGS}}
        {{else if eq .MODE "release"}}
        {{.CXX_RELEASE_FLAGS}}
        {{else}}
        {{fail "MODE must be one of `debug release`"}}
        {{end}}
    cmds:
      - '{{.CXX}} {{.CXX_FLAGS}} {{.CXX_SOURCES}}'
    requires:
      vars: [MODE, OUT_EXE]
    # Seems '{cpp,hpp}' or `[ch]pp` doesn't work with Windows
    sources:
      - '{{.SRC}}/*.cpp'
      - '{{.SRC}}/*.hpp'
    generates:
      - '{{.OUT_EXE}}'
  
  run:
    desc: '[Re]build the C++ executable if needed then run it.'
    deps:
      - task: build
    cmds:
      - '{{.OUT_EXE}}'
