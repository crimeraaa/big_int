version: '3'

vars:
  COMMON_FLAGS: -nologo -W4 -WX -std:c++17 -EHsc -permissive- -Zc:preprocessor -Zc:__cplusplus
  DEBUG_FLAGS: -Od -Zi -Fd:"{{.BIN}}/" -fsanitize=address -DDEBUG_USE_ASSERT
  RELEASE_FLAGS: -O1
  
tasks:
  default:
    cmds:
      - task: build

  build:
    desc: Builds the executable.
    deps:
      - task: :dirs
    vars:
      # Hack as long as `sources` is not supported in a variable and Windows CMD
      # cannot glob
      IN_SRC:
        sh: ls -1 '{{.SRC}}' | grep 'cpp' | awk '{print "{{.SRC}}/" $0}'
      FLAGS: '{{if eq .MODE "debug"}}
        {{.DEBUG_FLAGS}}
        {{else if eq .MODE "release"}}
        {{.RELEASE_FLAGS}}
        {{else}}
        {{fail "MODE must be one of `debug release`"}}
        {{end}}'
    cmds:
      - 'cl {{.COMMON_FLAGS}} {{.FLAGS}} -Fe:"{{.OUT_EXE}}" -Fo:"{{.OBJ}}/" {{.IN_SRC | replace "\n " " "}}'
    requires:
      vars: [MODE, OUT_EXE]
    sources:
      - '{{.SRC}}/*.{cpp,hpp}'
    generates:
      - '{{.OUT_EXE}}'
  
  run:
    desc: '[Re]uild the executable if needed then run it.'
    deps:
      - task: build
    cmds:
      - '{{.OUT_EXE}}'

  build-*:
    vars:
      MODE: '{{index .MATCH 0}}'
    desc: Sets MODE to 'debug' or 'release' then builds.
    cmds:
      - task: build
        vars:
          MODE: '{{.MODE}}'
  
  run-*:
    vars:
      MODE: '{{index .MATCH 0}}'
    desc: Sets MODE to 'debug' or 'release' then builds and runs.
    cmds:
      - task: run
        vars:
          MODE: '{{.MODE}}'
